// CI Builder Image Pipeline
@Library('imagebuilder-shared') _

pipeline {
    agent {
        kubernetes {
            cloud 'kubernetes'
            yaml '''
apiVersion: v1
kind: Pod
spec:
  serviceAccount: jenkins-deployer
  nodeSelector:
    node-type: edge
  volumes:
    - name: containerd-sock
      hostPath:
        path: /var/snap/microk8s/common/run/containerd.sock
        type: Socket
    - name: buildkit-run
      emptyDir: {}
  containers:
    - name: builder
      image: harbor.ethosengine.com/ethosengine/ci-builder:latest
      command:
        - cat
      tty: true
      resources:
        requests:
          ephemeral-storage: "2Gi"
        limits:
          ephemeral-storage: "4Gi"
      volumeMounts:
        - name: containerd-sock
          mountPath: /run/containerd/containerd.sock
        - name: buildkit-run
          mountPath: /run/buildkit
    - name: buildkitd
      image: moby/buildkit:v0.12.5
      securityContext:
        privileged: true
      args:
        - --addr
        - unix:///run/buildkit/buildkitd.sock
        - --oci-worker=true
        - --containerd-worker=false
      volumeMounts:
        - name: containerd-sock
          mountPath: /run/containerd/containerd.sock
        - name: buildkit-run
          mountPath: /run/buildkit
'''
        }
    }

    parameters {
        booleanParam(name: 'FORCE_BUILD', defaultValue: false,
                     description: 'Force rebuild even if no changes')
        booleanParam(name: 'SKIP_PUSH', defaultValue: false,
                     description: 'Skip pushing to Harbor (testing only)')
        booleanParam(name: 'SKIP_SECURITY_SCAN', defaultValue: false,
                     description: 'Skip Harbor security scanning')
        booleanParam(name: 'SKIP_SMOKE_TESTS', defaultValue: false,
                     description: 'Skip smoke tests')
    }

    stages {
        stage('Checkout') {
            steps {
                container('builder') {
                    script {
                        checkout scm
                        sh 'git config --global --add safe.directory $(pwd)'
                        sh 'git clean -fdx'
                        sh 'git reset --hard HEAD'
                        echo "Building from branch: ${env.BRANCH_NAME ?: 'main'}"
                    }
                }
            }
        }

        stage('Build & Push') {
            steps {
                container('builder') {
                    script {
                        def result = buildDevspaceImage(
                            imageName: 'ci-builder',
                            dockerfile: 'containers/ci-builder',
                            registry: 'harbor.ethosengine.com/ethosengine',
                            skipBaseImageCheck: true,  // ci-builder doesn't track base image changes
                            forceBuild: params.FORCE_BUILD,
                            skipPush: params.SKIP_PUSH,
                            skipSecurityScan: params.SKIP_SECURITY_SCAN,
                            skipSmokeTests: params.SKIP_SMOKE_TESTS
                        )

                        env.BUILD_RESULT = result.skipped ? 'SKIPPED' : 'SUCCESS'
                        env.IMAGE_NAME = result.fullImageName
                    }
                }
            }
        }
    }

    post {
        always {
            container('builder') {
                script {
                    if (env.IMAGE_TAG_DATED && env.IMAGE_TAG_GIT) {
                        sh """
                            set +e
                            nerdctl -n k8s.io rmi harbor.ethosengine.com/ethosengine/ci-builder:latest 2>/dev/null || true
                            nerdctl -n k8s.io rmi harbor.ethosengine.com/ethosengine/ci-builder:${IMAGE_TAG_DATED} 2>/dev/null || true
                            nerdctl -n k8s.io rmi harbor.ethosengine.com/ethosengine/ci-builder:${IMAGE_TAG_GIT} 2>/dev/null || true
                        """
                    }
                }
            }
        }
        success {
            script {
                echo "âœ… ci-builder pipeline completed: ${env.BUILD_RESULT}"
                if (env.IMAGE_NAME) {
                    echo "Image: ${env.IMAGE_NAME}"
                }
            }
        }
    }
}
