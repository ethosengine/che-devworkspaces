schemaVersion: 2.2.0
metadata:
  name: workspace-dev
  displayName: Che Image and Workspace Development
  description: >-
    Universal Developer Image provides various programming languages tools and
    runtimes for instant coding
  icon: >-
    https://raw.githubusercontent.com/devfile/devfile-web/main/apps/landing-page/public/pwa-192x192.png
  tags:
    - Java
    - Maven
    - Scala
    - PHP
    - .NET
    - Node.js
    - Go
    - Python
    - Pip
    - ubi9
  projectType: universal
  language: Polyglot
  version: 1.0.0
  projects:
  - name: che-devworkspaces
    git:
      remotes:
        origin: https://github.com/ethosengine/che-devworkspaces.git
components:
  - name: tools
    container:
      image: harbor.ethosengine.com/devspaces/udi-plus:ubi9-plus-latest
      memoryLimit: 6G
      memoryRequest: 512Mi
      cpuRequest: 1000m
      cpuLimit: 4000m
      mountSources: true
      env:
        - name: CLAUDE_CONFIG_DIR
          value: /tmp/claude-config
        - name: STORAGE_PATH
          value: /tmp/sonarqube-mcp-storage
commands:
- id: setup-claude-mcp
  exec:
    component: tools
    commandLine: |
      set -e     
      # Add to bashrc for persistence
      echo "export SONARQUBE_URL='$SONARQUBE_URL'" >> ~/.bashrc
      echo "export SONARQUBE_TOKEN='$SONARQUBE_TOKEN'" >> ~/.bashrc
      echo "export STORAGE_PATH='$STORAGE_PATH'" >> ~/.bashrc
      
      # Create storage directory
      mkdir -p "$STORAGE_PATH"
      echo "Created storage directory: $STORAGE_PATH"
      
      # Verify setup prerequisites
      echo "Java version:"
      java -version
      echo "SonarQube MCP JAR:"
      ls -la /opt/mcp/sonarqube-mcp.jar
      
      claude mcp remove sonarqube 2>/dev/null || echo "No existing sonarqube MCP server to remove"

      claude mcp add sonarqube \
        --env STORAGE_PATH="$STORAGE_PATH" \
        --env SONARQUBE_TOKEN="$SONARQUBE_TOKEN" \
        --env SONARQUBE_URL="$SONARQUBE_URL" \
        -- java -jar /opt/mcp/sonarqube-mcp.jar
      
      # Verify the server was added
      echo "Configured MCP servers:"
      claude mcp list
      
      echo "Claude MCP setup completed successfully!"

events:
  postStart:
    - setup-claude-mcp