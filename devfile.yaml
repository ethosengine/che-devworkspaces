schemaVersion: 2.2.0
metadata:
  name: workspace-dev
  displayName: Che Image and Workspace Development
  description: >-
    Universal Developer Image provides various programming languages tools and
    runtimes for instant coding
  icon: >-
    https://raw.githubusercontent.com/devfile/devfile-web/main/apps/landing-page/public/pwa-192x192.png
  tags:
    - Java
    - Maven
    - Scala
    - PHP
    - .NET
    - Node.js
    - Go
    - Python
    - Pip
    - ubi9
  projectType: universal
  language: Polyglot
  version: 1.0.0
  projects:
  - name: che-devworkspaces
    git:
      remotes:
        origin: https://github.com/ethosengine/che-devworkspaces.git
components:
  - name: tools
    container:
      image: harbor.ethosengine.com/devspaces/udi-plus:latest
      memoryLimit: 6G
      memoryRequest: 512Mi
      cpuRequest: 1000m
      cpuLimit: 4000m
      mountSources: true
      env:
        - name: CLAUDE_CONFIG_DIR
          value: /tmp/claude-config
        - name: JENKINS_URL
          value: "https://jenkins.ethosengine.com"
commands:
- id: setup-claude-mcp
  exec:
    component: tools
    workingDir: /projects/che-devworkspaces
    commandLine: |
      export STORAGE_PATH=/tmp/sonarqube-mcp-storage
      mkdir -p "$STORAGE_PATH"
      claude mcp remove sonarqube 2>/dev/null || true
      claude mcp add sonarqube \
        --env STORAGE_PATH="$STORAGE_PATH" \
        --env SONARQUBE_TOKEN="$SONARQUBE_TOKEN" \
        --env SONARQUBE_URL="$SONARQUBE_URL" \
        -- java -jar /opt/mcp/sonarqube-mcp.jar
      claude mcp remove jenkins 2>/dev/null || true
      
      export JENKINS_AUTH=$(echo -n "$JENKINS_USERNAME:$JENKINS_TOKEN" | base64)
      
      # Add Jenkins MCP server using HTTP transport
      claude mcp add jenkins "$JENKINS_URL/mcp-server/mcp" \
        --transport http \
        --header "Authorization: Basic $JENKINS_AUTH" \
        --env JENKINS_URL="$JENKINS_URL" \
        --env JENKINS_USERNAME="$JENKINS_USERNAME" \
        --env JENKINS_TOKEN="$JENKINS_TOKEN"      


        
events:
  postStart:
    - setup-claude-mcp
